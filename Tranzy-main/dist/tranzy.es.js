/**
 * Tranzy.js - 专业的网页国际化解决方案 | JavaScript自动翻译库
 *
 * 主要功能：
 * 1. 自动检测DOM变化并翻译新增内容
 * 2. 支持批量翻译和缓存机制
 * 3. 提供灵活的配置选项和钩子函数
 * 4. 支持手动翻译词典和术语处理
 * 5. 内置微软翻译API实现
 *
 * 使用方式：
 * 1. 直接使用翻译功能：
 *    import { translateText } from 'tranzy';
 *    const result = await translateText(['Hello'], 'zh', 'en');
 *
 * 2. 使用页面翻译功能：
 *    import Tranzy from 'tranzy';
 *    const tranzy = new Tranzy({
 *      toLang: 'zh',
 *      fromLang: 'en'
 *    });
 *    await tranzy.translatePage();
 *
 * @author Fts Cloud <ftsuperb@vip.qq.com>
 * @license MIT
 * @repository https://github.com/FtsCloud/Tranzy
 * @copyright Copyright (c) 2023-present Fts Cloud
 */
const t=["style","script","noscript","kbd","code","pre","input","textarea",'[contenteditable="true"]',".tranzy-ignore"],e={toLang:navigator.language||"",fromLang:"",ignore:[],force:[],doneClass:"tranzy-done",pendingClass:"tranzy-pending",translateFn:r,manualDict:{},beforeTranslate:null,afterTranslate:null};class n{constructor(t,e=""){this.dbName=`tranzy-${t}${e?"-"+e:""}`,this.storeName="translations",this.db=null,this.initPromise=this._initDatabase()}_generateHash(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e*=16777619;return e.toString(36)}async _initDatabase(){return new Promise(((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName,{keyPath:"id"})},n.onsuccess=e=>{this.db=e.target.result,t()},n.onerror=t=>{console.error(`Tranzy: Failed to initialize cache database / 初始化缓存数据库失败: ${this.dbName}`,t.target.error),e(t.target.error)}}))}async get(t){await this.initPromise;const e=this._generateHash(t);return new Promise((t=>{if(!this.db)return void t(null);const n=this.db.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);n.onsuccess=e=>{t(e.target.result?.value||null)},n.onerror=()=>{t(null)}}))}async set(t,e){await this.initPromise;const n=this._generateHash(t);return new Promise((t=>{if(!this.db)return void t();const s=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).put({id:n,value:e});s.onsuccess=()=>{t()},s.onerror=()=>{t()}}))}async setBatch(t,e){await this.initPromise,await Promise.all(t.map(((t,n)=>this.set(t,e[n]))))}destroy(){this.db&&(this.db.close(),this.db=null)}}function s(){try{sessionStorage.removeItem("tranzy_auth_token")}catch(t){console.error("Tranzy: Failed to clear token from session / 清除session中的token失败",t)}}async function o(){const t=Date.now(),{token:e,timestamp:n}=function(){try{const t=sessionStorage.getItem("tranzy_auth_token");if(t){const{token:e,timestamp:n}=JSON.parse(t),o=Date.now();if(e&&o-n<6e5)return{token:e,timestamp:n};s()}}catch(t){console.error("Tranzy: Failed to load token from session / 从session加载token失败",t),s()}return{token:null,timestamp:0}}();if(e&&t-n<6e5)return e;try{const e=await fetch("https://edge.microsoft.com/translate/auth",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return console.error(`Tranzy: Failed to get Microsoft Translator authorization / 获取微软翻译授权失败: ${e.status} ${e.statusText}`),null;const n=await e.text();return function(t,e){try{sessionStorage.setItem("tranzy_auth_token",JSON.stringify({token:t,timestamp:e}))}catch(t){console.error("Tranzy: Failed to save token to session / 保存token到session失败",t)}}(n,t),n}catch(t){throw console.error("Tranzy: Failed to get Microsoft Translator authorization / 获取微软翻译授权失败",t),s(),t}}async function r(t,e=navigator.language,n=""){try{const s=t.filter((t=>t?.trim()));if(0===s.length)return[];const r=await o(),i=`https://api.cognitive.microsofttranslator.com/translate?${n?`from=${n}&`:""}to=${e}&api-version=3.0`,a=s.map((t=>({Text:t}))),c=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(a)});if(!c.ok)return console.error(`Tranzy: Translation request failed / 翻译请求失败: ${c.status} ${c.statusText}`),t;return(await c.json()).map((t=>t.translations[0].text))}catch(t){throw console.error("Tranzy: Translation request failed / 翻译请求失败",t),t}}async function i(t){try{const e=(Array.isArray(t)?t:[t]).filter((t=>t?.trim()));if(0===e.length)return[];const n=await o(),s=e.map((t=>({Text:t}))),r=await fetch("https://api.cognitive.microsofttranslator.com/detect?api-version=3.0",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(s)});return r.ok?await r.json():(console.error(`Tranzy: Language detection request failed / 语言检测请求失败: ${r.status} ${r.statusText}`),[])}catch(t){throw console.error("Tranzy: Language detection failed / 语言检测失败",t),t}}async function a(t=""){try{const e={"Content-Type":"application/json"};t&&(e["Accept-Language"]=t);const n=await fetch("https://api.cognitive.microsofttranslator.com/languages?api-version=3.0",{method:"GET",headers:e});if(!n.ok)return console.error(`Tranzy: Failed to get supported languages / 获取支持语种列表失败: ${n.status} ${n.statusText}`),{};return(await n.json()).translation}catch(t){throw console.error("Tranzy: Failed to get supported languages / 获取支持语种列表失败",t),t}}async function c(){try{const t=navigator.language,e=await o(),n=await fetch(`https://api.cognitive.microsofttranslator.com/translate?to=${t}&api-version=3.0`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify([{Text:""}])});if(!n.ok)return console.error(`Tranzy: Failed to get browser language / 获取浏览器语言失败: ${n.status} ${n.statusText}`),navigator.language||"en";return(await n.json())[0].translations[0].to}catch(t){throw console.error("Tranzy: Failed to get browser language / 获取浏览器语言失败",t),t}}class l{constructor(s={}){this.config={...e,...s},this.config.manualDict[this.config.toLang]={...this.config.manualDict.all||{},...this.config.manualDict[this.config.toLang]||{}};const o=this.config.manualDict[this.config.toLang];for(const t of Object.keys(o))"string"==typeof o[t]&&(o[t]={to:o[t],standalone:!0,case:!0});this.observer=null,this.translationCache=new n(this.config.toLang,this.config.fromLang),this.config.ignore=[...new Set([...t,...this.config.ignore||[]])],this.config.force=this.config.force||[],this.forceSelectorString=this.config.force.length?this.config.force.join(","):"",this.ignoreSelectorString=this.config.ignore.length?this.config.ignore.join(","):"",this.isTranslating=!1,this.pendingElements=new Set,this.observerConfig={childList:!0,subtree:!0,characterData:!0}}_createNodeFilter(){return{acceptNode:function(t){if(t.classList.contains(this.config.doneClass))return NodeFilter.FILTER_SKIP;if(this.forceSelectorString&&t.matches(this.forceSelectorString))return NodeFilter.FILTER_ACCEPT;if(this.forceSelectorString){let e=t.parentNode;for(;e&&e!==document;){if(e.matches(this.forceSelectorString))return NodeFilter.FILTER_ACCEPT;e=e.parentNode}}let e=!1;if(this.forceSelectorString&&t.children.length>0&&(e=t.querySelector(this.forceSelectorString)),this.ignoreSelectorString&&t.matches(this.ignoreSelectorString))return e?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_REJECT;if(this.ignoreSelectorString){let n=t.parentNode;for(;n&&n!==document;){if(n.matches(this.ignoreSelectorString))return e?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_REJECT;n=n.parentNode}}return NodeFilter.FILTER_ACCEPT}.bind(this)}}startObserver(t="body"){return this.config.fromLang===this.config.toLang||(this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((t=>{let e=!1;for(const n of t){if("childList"===n.type&&n.addedNodes.length>0)for(const t of n.addedNodes)if(t.nodeType===Node.ELEMENT_NODE){const n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,this._createNodeFilter());let s=n.nextNode();for(;s;)this.pendingElements.add(s),e=!0,s=n.nextNode()}if("characterData"===n.type){const t=n.target.parentNode;if(t&&t.nodeType===Node.ELEMENT_NODE){if(t.classList.contains(this.config.pendingClass))continue;let n=!1,s=t;for(;s;){if(this.ignoreSelectorString&&s.matches(this.ignoreSelectorString)&&(!this.forceSelectorString||!s.matches(this.forceSelectorString))){n=!0;break}if(s=s.parentNode,!s||s===document)break}n||(this.pendingElements.add(t),e=!0)}}}e&&this._translatePending()})),this.observer.observe(document.querySelector(t),this.observerConfig)),this}stopObserver(){return this.observer&&(this.observer.disconnect(),this.observer=null),this}async _translatePending(t=!1){if(0===this.pendingElements.size||this.isTranslating)return;t||"function"!=typeof this.config.beforeTranslate||this.config.beforeTranslate(),this.isTranslating=!0;const e=Array.from(this.pendingElements);this.pendingElements.clear(),await this._translateElements(e),this.isTranslating=!1,this.pendingElements.size>0?this._translatePending(!0):"function"==typeof this.config.afterTranslate&&this.config.afterTranslate()}async translatePage(t="body"){if(this.isTranslating||this.config.fromLang===this.config.toLang)return this;this.isTranslating=!0;const e=!!this.observer;e&&this.stopObserver(),"function"==typeof this.config.beforeTranslate&&this.config.beforeTranslate();try{const e=[],n=document.querySelector(t),s=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,this._createNodeFilter());let o=s.nextNode();for(;o;)e.push(o),o=s.nextNode();await this._translateElements(e)}catch(t){console.error("Tranzy: Page translation failed / 页面翻译失败",t)}finally{"function"==typeof this.config.afterTranslate&&this.config.afterTranslate(),this.isTranslating=!1,e&&this.startObserver(t)}return this}async _translateElements(t){const e=[],n=[];for(const s of t){const t=this._getElementText(s);t&&(e.push(s),n.push(t))}if(0!==e.length)for(let t=0;t<e.length;t+=100){const s=e.slice(t,t+100),o=n.slice(t,t+100);await this._translateElementBatch(s,o)}}_splitByTerms(t){const e=this.config.manualDict[this.config.toLang];if(!e)return[t];const n=Object.keys(e).sort(((t,e)=>e.length-t.length));for(const s of n){const n=e[s];if(!1!==n.standalone&&(!1===n.case?t.toLowerCase()===s.toLowerCase():t===s))return[t]}let s=!1;for(const o of n){if(!1===e[o].case?t.toLowerCase().includes(o.toLowerCase()):t.includes(o)){s=!0;break}}if(!s)return[t];const o=[];let r=t;for(;r.length>0;){let t=!1;for(const s of n){const n=e[s];if(!1!==n.standalone)continue;const i=!1===n.case?"gi":"g",a=new RegExp(`\\b${s}\\b`,i).exec(r);if(a){const e=a.index;e>0&&o.push(r.substring(0,e)),o.push(s),r=r.substring(e+s.length),t=!0;break}}if(!t){o.push(r);break}}return o}_getDirectTextNodes(t){const e=[],n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:e=>e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let s=n.nextNode();for(;s;){const t=s.textContent,o=t.trim();o&&e.push({node:s,text:o,leadingSpaces:t.match(/^\s*/)[0],trailingSpaces:t.match(/\s*$/)[0]}),s=n.nextNode()}return e}async _translateElementBatch(t,e){const n=[],s=[];for(let o=0;o<t.length;o++){const r=t[o],i=e[o];n.push(r),s.push(i),r.classList.add(this.config.pendingClass)}if(0===s.length)return;const o=new Map;for(let t=0;t<n.length;t++){const e=n[t];if(e.childElementCount>0){const r=this._getDirectTextNodes(e);if(r.length>1){o.set(e,r);for(const t of r)s.push(t.text),n.push({isTextNode:!0,nodeInfo:t});s[t]=null}}}const r=n.filter(((t,e)=>null!==s[e])),i=s.filter((t=>null!==t)),a=[],c=new Map;for(const t of i){if(!t)continue;const e=this._splitByTerms(t);if(e.length>1){c.set(t,e);for(const t of e)a.push(t)}else a.push(t)}const l=[...new Set(a)],h={};let g=[];for(const t of l){const e=this.config.manualDict[this.config.toLang],n=e&&(e[t]||(!1===e[t.toLowerCase()]?.case?e[t.toLowerCase()]:null));if(n)h[t]=n.to;else{const e=await this.translationCache.get(t);e?h[t]=e:g.push(t)}}if(g=g.filter((t=>/^(?![\d\s\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E\r\n，。？！；：“”‘’【】（）·《》…]*$).+/.test(t))),g.length>0)try{const t=await this.config.translateFn(g,this.config.toLang,this.config.fromLang);await this.translationCache.setBatch(g,t);for(let e=0;e<g.length;e++)h[g[e]]=t[e]}catch(t){console.error("Tranzy: Batch translation failed / 批量翻译失败",t);for(const t of g)h[t]=t}const f=new Map;for(const[t,e]of c.entries()){const n=e.map((t=>h[t]||t));f.set(t,n.join(""))}for(const t of i)t&&!c.has(t)&&f.set(t,h[t]||t);r.forEach(((t,e)=>{const n=i[e];if(!n)return;const s=f.get(n);if(s)if(t.isTextNode){const{node:e,leadingSpaces:n,trailingSpaces:o}=t.nodeInfo;e.textContent=n+s+o;const r=e.parentNode;r&&queueMicrotask((()=>{r.classList.remove(this.config.pendingClass),r.classList.add(this.config.doneClass)}))}else o.has(t)||this._applyTranslation(t,n,s),queueMicrotask((()=>{t.classList.remove(this.config.pendingClass),t.classList.add(this.config.doneClass)}))}))}_getElementText(t){let e="";const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:e=>e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let s=n.nextNode();for(;s;){const t=s.textContent.trim();t&&(e+=`${t} `),s=n.nextNode()}return e=e.trim(),e}_applyTranslation(t,e,n){if(n&&e!==n)if(t.classList.add(this.config.doneClass),t.childElementCount>0){const e=this._getDirectTextNodes(t);if(0===e.length)return;if(1===e.length){const{node:t,leadingSpaces:s,trailingSpaces:o}=e[0];return void(t.textContent=s+n+o)}const s=e.reduce(((t,e)=>t+e.text.length),0);let o=0;e.forEach(((t,r)=>{const{node:i,text:a,leadingSpaces:c,trailingSpaces:l}=t;let h;if(r===e.length-1)h=n.substring(o);else{const t=a.length/s,e=Math.round(n.length*t);h=n.substring(o,o+e),o+=e}i.textContent=c+h+l}))}else{const e=t.textContent.match(/^\s*/)[0],s=t.textContent.match(/\s*$/)[0];t.textContent=e+n+s}}destroy(){return this.stopObserver(),this.pendingElements.clear(),this.translationCache&&(this.translationCache.destroy(),this.translationCache=null),this.isTranslating=!1,this}}export{l as Translator,l as default,i as detectLang,c as getBrowserLang,a as getSupportedLangs,r as translateText};
//# sourceMappingURL=tranzy.es.js.map
