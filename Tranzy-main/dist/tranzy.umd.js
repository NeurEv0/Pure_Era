!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Tranzy={})}(this,(function(t){"use strict";
/**
   * Tranzy.js - 专业的网页国际化解决方案 | JavaScript自动翻译库
   *
   * 主要功能：
   * 1. 自动检测DOM变化并翻译新增内容
   * 2. 支持批量翻译和缓存机制
   * 3. 提供灵活的配置选项和钩子函数
   * 4. 支持手动翻译词典和术语处理
   * 5. 内置微软翻译API实现
   *
   * 使用方式：
   * 1. 直接使用翻译功能：
   *    import { translateText } from 'tranzy';
   *    const result = await translateText(['Hello'], 'zh', 'en');
   *
   * 2. 使用页面翻译功能：
   *    import Tranzy from 'tranzy';
   *    const tranzy = new Tranzy({
   *      toLang: 'zh',
   *      fromLang: 'en'
   *    });
   *    await tranzy.translatePage();
   *
   * @author Fts Cloud <ftsuperb@vip.qq.com>
   * @license MIT
   * @repository https://github.com/FtsCloud/Tranzy
   * @copyright Copyright (c) 2023-present Fts Cloud
   */const e=["style","script","noscript","kbd","code","pre","input","textarea",'[contenteditable="true"]',".tranzy-ignore"],n={toLang:navigator.language||"",fromLang:"",ignore:[],force:[],doneClass:"tranzy-done",pendingClass:"tranzy-pending",translateFn:i,manualDict:{},beforeTranslate:null,afterTranslate:null};class o{constructor(t,e=""){this.dbName=`tranzy-${t}${e?"-"+e:""}`,this.storeName="translations",this.db=null,this.initPromise=this._initDatabase()}_generateHash(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e*=16777619;return e.toString(36)}async _initDatabase(){return new Promise(((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName,{keyPath:"id"})},n.onsuccess=e=>{this.db=e.target.result,t()},n.onerror=t=>{console.error(`Tranzy: Failed to initialize cache database / 初始化缓存数据库失败: ${this.dbName}`,t.target.error),e(t.target.error)}}))}async get(t){await this.initPromise;const e=this._generateHash(t);return new Promise((t=>{if(!this.db)return void t(null);const n=this.db.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);n.onsuccess=e=>{t(e.target.result?.value||null)},n.onerror=()=>{t(null)}}))}async set(t,e){await this.initPromise;const n=this._generateHash(t);return new Promise((t=>{if(!this.db)return void t();const o=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).put({id:n,value:e});o.onsuccess=()=>{t()},o.onerror=()=>{t()}}))}async setBatch(t,e){await this.initPromise,await Promise.all(t.map(((t,n)=>this.set(t,e[n]))))}destroy(){this.db&&(this.db.close(),this.db=null)}}function s(){try{sessionStorage.removeItem("tranzy_auth_token")}catch(t){console.error("Tranzy: Failed to clear token from session / 清除session中的token失败",t)}}async function r(){const t=Date.now(),{token:e,timestamp:n}=function(){try{const t=sessionStorage.getItem("tranzy_auth_token");if(t){const{token:e,timestamp:n}=JSON.parse(t),o=Date.now();if(e&&o-n<6e5)return{token:e,timestamp:n};s()}}catch(t){console.error("Tranzy: Failed to load token from session / 从session加载token失败",t),s()}return{token:null,timestamp:0}}();if(e&&t-n<6e5)return e;try{const e=await fetch("https://edge.microsoft.com/translate/auth",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)return console.error(`Tranzy: Failed to get Microsoft Translator authorization / 获取微软翻译授权失败: ${e.status} ${e.statusText}`),null;const n=await e.text();return function(t,e){try{sessionStorage.setItem("tranzy_auth_token",JSON.stringify({token:t,timestamp:e}))}catch(t){console.error("Tranzy: Failed to save token to session / 保存token到session失败",t)}}(n,t),n}catch(t){throw console.error("Tranzy: Failed to get Microsoft Translator authorization / 获取微软翻译授权失败",t),s(),t}}async function i(t,e=navigator.language,n=""){try{const o=t.filter((t=>t?.trim()));if(0===o.length)return[];const s=await r(),i=`https://api.cognitive.microsofttranslator.com/translate?${n?`from=${n}&`:""}to=${e}&api-version=3.0`,a=o.map((t=>({Text:t}))),c=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(a)});if(!c.ok)return console.error(`Tranzy: Translation request failed / 翻译请求失败: ${c.status} ${c.statusText}`),t;return(await c.json()).map((t=>t.translations[0].text))}catch(t){throw console.error("Tranzy: Translation request failed / 翻译请求失败",t),t}}class a{constructor(t={}){this.config={...n,...t},this.config.manualDict[this.config.toLang]={...this.config.manualDict.all||{},...this.config.manualDict[this.config.toLang]||{}};const s=this.config.manualDict[this.config.toLang];for(const t of Object.keys(s))"string"==typeof s[t]&&(s[t]={to:s[t],standalone:!0,case:!0});this.observer=null,this.translationCache=new o(this.config.toLang,this.config.fromLang),this.config.ignore=[...new Set([...e,...this.config.ignore||[]])],this.config.force=this.config.force||[],this.forceSelectorString=this.config.force.length?this.config.force.join(","):"",this.ignoreSelectorString=this.config.ignore.length?this.config.ignore.join(","):"",this.isTranslating=!1,this.pendingElements=new Set,this.observerConfig={childList:!0,subtree:!0,characterData:!0}}_createNodeFilter(){return{acceptNode:function(t){if(t.classList.contains(this.config.doneClass))return NodeFilter.FILTER_SKIP;if(this.forceSelectorString&&t.matches(this.forceSelectorString))return NodeFilter.FILTER_ACCEPT;if(this.forceSelectorString){let e=t.parentNode;for(;e&&e!==document;){if(e.matches(this.forceSelectorString))return NodeFilter.FILTER_ACCEPT;e=e.parentNode}}let e=!1;if(this.forceSelectorString&&t.children.length>0&&(e=t.querySelector(this.forceSelectorString)),this.ignoreSelectorString&&t.matches(this.ignoreSelectorString))return e?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_REJECT;if(this.ignoreSelectorString){let n=t.parentNode;for(;n&&n!==document;){if(n.matches(this.ignoreSelectorString))return e?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_REJECT;n=n.parentNode}}return NodeFilter.FILTER_ACCEPT}.bind(this)}}startObserver(t="body"){return this.config.fromLang===this.config.toLang||(this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((t=>{let e=!1;for(const n of t){if("childList"===n.type&&n.addedNodes.length>0)for(const t of n.addedNodes)if(t.nodeType===Node.ELEMENT_NODE){const n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,this._createNodeFilter());let o=n.nextNode();for(;o;)this.pendingElements.add(o),e=!0,o=n.nextNode()}if("characterData"===n.type){const t=n.target.parentNode;if(t&&t.nodeType===Node.ELEMENT_NODE){if(t.classList.contains(this.config.pendingClass))continue;let n=!1,o=t;for(;o;){if(this.ignoreSelectorString&&o.matches(this.ignoreSelectorString)&&(!this.forceSelectorString||!o.matches(this.forceSelectorString))){n=!0;break}if(o=o.parentNode,!o||o===document)break}n||(this.pendingElements.add(t),e=!0)}}}e&&this._translatePending()})),this.observer.observe(document.querySelector(t),this.observerConfig)),this}stopObserver(){return this.observer&&(this.observer.disconnect(),this.observer=null),this}async _translatePending(t=!1){if(0===this.pendingElements.size||this.isTranslating)return;t||"function"!=typeof this.config.beforeTranslate||this.config.beforeTranslate(),this.isTranslating=!0;const e=Array.from(this.pendingElements);this.pendingElements.clear(),await this._translateElements(e),this.isTranslating=!1,this.pendingElements.size>0?this._translatePending(!0):"function"==typeof this.config.afterTranslate&&this.config.afterTranslate()}async translatePage(t="body"){if(this.isTranslating||this.config.fromLang===this.config.toLang)return this;this.isTranslating=!0;const e=!!this.observer;e&&this.stopObserver(),"function"==typeof this.config.beforeTranslate&&this.config.beforeTranslate();try{const e=[],n=document.querySelector(t),o=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,this._createNodeFilter());let s=o.nextNode();for(;s;)e.push(s),s=o.nextNode();await this._translateElements(e)}catch(t){console.error("Tranzy: Page translation failed / 页面翻译失败",t)}finally{"function"==typeof this.config.afterTranslate&&this.config.afterTranslate(),this.isTranslating=!1,e&&this.startObserver(t)}return this}async _translateElements(t){const e=[],n=[];for(const o of t){const t=this._getElementText(o);t&&(e.push(o),n.push(t))}if(0!==e.length)for(let t=0;t<e.length;t+=100){const o=e.slice(t,t+100),s=n.slice(t,t+100);await this._translateElementBatch(o,s)}}_splitByTerms(t){const e=this.config.manualDict[this.config.toLang];if(!e)return[t];const n=Object.keys(e).sort(((t,e)=>e.length-t.length));for(const o of n){const n=e[o];if(!1!==n.standalone&&(!1===n.case?t.toLowerCase()===o.toLowerCase():t===o))return[t]}let o=!1;for(const s of n){if(!1===e[s].case?t.toLowerCase().includes(s.toLowerCase()):t.includes(s)){o=!0;break}}if(!o)return[t];const s=[];let r=t;for(;r.length>0;){let t=!1;for(const o of n){const n=e[o];if(!1!==n.standalone)continue;const i=!1===n.case?"gi":"g",a=new RegExp(`\\b${o}\\b`,i).exec(r);if(a){const e=a.index;e>0&&s.push(r.substring(0,e)),s.push(o),r=r.substring(e+o.length),t=!0;break}}if(!t){s.push(r);break}}return s}_getDirectTextNodes(t){const e=[],n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:e=>e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let o=n.nextNode();for(;o;){const t=o.textContent,s=t.trim();s&&e.push({node:o,text:s,leadingSpaces:t.match(/^\s*/)[0],trailingSpaces:t.match(/\s*$/)[0]}),o=n.nextNode()}return e}async _translateElementBatch(t,e){const n=[],o=[];for(let s=0;s<t.length;s++){const r=t[s],i=e[s];n.push(r),o.push(i),r.classList.add(this.config.pendingClass)}if(0===o.length)return;const s=new Map;for(let t=0;t<n.length;t++){const e=n[t];if(e.childElementCount>0){const r=this._getDirectTextNodes(e);if(r.length>1){s.set(e,r);for(const t of r)o.push(t.text),n.push({isTextNode:!0,nodeInfo:t});o[t]=null}}}const r=n.filter(((t,e)=>null!==o[e])),i=o.filter((t=>null!==t)),a=[],c=new Map;for(const t of i){if(!t)continue;const e=this._splitByTerms(t);if(e.length>1){c.set(t,e);for(const t of e)a.push(t)}else a.push(t)}const l=[...new Set(a)],h={};let f=[];for(const t of l){const e=this.config.manualDict[this.config.toLang],n=e&&(e[t]||(!1===e[t.toLowerCase()]?.case?e[t.toLowerCase()]:null));if(n)h[t]=n.to;else{const e=await this.translationCache.get(t);e?h[t]=e:f.push(t)}}if(f=f.filter((t=>/^(?![\d\s\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E\r\n，。？！；：“”‘’【】（）·《》…]*$).+/.test(t))),f.length>0)try{const t=await this.config.translateFn(f,this.config.toLang,this.config.fromLang);await this.translationCache.setBatch(f,t);for(let e=0;e<f.length;e++)h[f[e]]=t[e]}catch(t){console.error("Tranzy: Batch translation failed / 批量翻译失败",t);for(const t of f)h[t]=t}const g=new Map;for(const[t,e]of c.entries()){const n=e.map((t=>h[t]||t));g.set(t,n.join(""))}for(const t of i)t&&!c.has(t)&&g.set(t,h[t]||t);r.forEach(((t,e)=>{const n=i[e];if(!n)return;const o=g.get(n);if(o)if(t.isTextNode){const{node:e,leadingSpaces:n,trailingSpaces:s}=t.nodeInfo;e.textContent=n+o+s;const r=e.parentNode;r&&queueMicrotask((()=>{r.classList.remove(this.config.pendingClass),r.classList.add(this.config.doneClass)}))}else s.has(t)||this._applyTranslation(t,n,o),queueMicrotask((()=>{t.classList.remove(this.config.pendingClass),t.classList.add(this.config.doneClass)}))}))}_getElementText(t){let e="";const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:e=>e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let o=n.nextNode();for(;o;){const t=o.textContent.trim();t&&(e+=`${t} `),o=n.nextNode()}return e=e.trim(),e}_applyTranslation(t,e,n){if(n&&e!==n)if(t.classList.add(this.config.doneClass),t.childElementCount>0){const e=this._getDirectTextNodes(t);if(0===e.length)return;if(1===e.length){const{node:t,leadingSpaces:o,trailingSpaces:s}=e[0];return void(t.textContent=o+n+s)}const o=e.reduce(((t,e)=>t+e.text.length),0);let s=0;e.forEach(((t,r)=>{const{node:i,text:a,leadingSpaces:c,trailingSpaces:l}=t;let h;if(r===e.length-1)h=n.substring(s);else{const t=a.length/o,e=Math.round(n.length*t);h=n.substring(s,s+e),s+=e}i.textContent=c+h+l}))}else{const e=t.textContent.match(/^\s*/)[0],o=t.textContent.match(/\s*$/)[0];t.textContent=e+n+o}}destroy(){return this.stopObserver(),this.pendingElements.clear(),this.translationCache&&(this.translationCache.destroy(),this.translationCache=null),this.isTranslating=!1,this}}t.Translator=a,t.default=a,t.detectLang=async function(t){try{const e=(Array.isArray(t)?t:[t]).filter((t=>t?.trim()));if(0===e.length)return[];const n=await r(),o=e.map((t=>({Text:t}))),s=await fetch("https://api.cognitive.microsofttranslator.com/detect?api-version=3.0",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(o)});return s.ok?await s.json():(console.error(`Tranzy: Language detection request failed / 语言检测请求失败: ${s.status} ${s.statusText}`),[])}catch(t){throw console.error("Tranzy: Language detection failed / 语言检测失败",t),t}},t.getBrowserLang=async function(){try{const t=navigator.language,e=await r(),n=await fetch(`https://api.cognitive.microsofttranslator.com/translate?to=${t}&api-version=3.0`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify([{Text:""}])});if(!n.ok)return console.error(`Tranzy: Failed to get browser language / 获取浏览器语言失败: ${n.status} ${n.statusText}`),navigator.language||"en";return(await n.json())[0].translations[0].to}catch(t){throw console.error("Tranzy: Failed to get browser language / 获取浏览器语言失败",t),t}},t.getSupportedLangs=async function(t=""){try{const e={"Content-Type":"application/json"};t&&(e["Accept-Language"]=t);const n=await fetch("https://api.cognitive.microsofttranslator.com/languages?api-version=3.0",{method:"GET",headers:e});if(!n.ok)return console.error(`Tranzy: Failed to get supported languages / 获取支持语种列表失败: ${n.status} ${n.statusText}`),{};return(await n.json()).translation}catch(t){throw console.error("Tranzy: Failed to get supported languages / 获取支持语种列表失败",t),t}},t.translateText=i,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=tranzy.umd.js.map
